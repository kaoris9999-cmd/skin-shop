<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN MASTER - SKIN ANOINTING</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    
    <style>
        body { font-family: sans-serif; padding: 10px; background: #f4f4f4; margin: 0; }
        .container { max-width: 600px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; }
        
        input, textarea { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; padding: 14px; background: #1a1a1a; color: #fff; border: none; cursor: pointer; margin-top: 10px; font-weight: bold; }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì„¸ë¶„í™” */
        button.del-btn { background: #d9534f; width: auto; padding: 5px 10px; font-size: 12px; margin-left: 5px; }
        button.edit-btn { background: #555; width: auto; padding: 5px 10px; font-size: 12px; }
        button.reset-btn { background: #999; margin-top: 5px; }

        .tab-menu { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .tab-btn { flex: 1; padding: 10px; background: #fff; border: 1px solid #ddd; cursor: pointer; font-weight: bold; color: #777; }
        .tab-btn.active { background: #1a1a1a; color: #fff; border: none; }
        
        .form-group { display: none; }
        .form-group.active { display: block; }
        
        /* ëª©ë¡ ìŠ¤íƒ€ì¼ */
        .item-list { 
            margin-top: 30px; border-top: 2px solid #333; padding-top: 10px; 
            max-height: 500px; overflow-y: auto; 
        }
        .item-row { 
            display: flex; justify-content: space-between; align-items: center; 
            background: #f9f9f9; padding: 15px; margin-bottom: 8px; 
            border: 1px solid #eee; border-radius: 4px; 
        }
        .item-info { flex-grow: 1; font-weight: bold; font-size: 14px; margin-right: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
        
        .loading { color: orange; text-align: center; display: none; margin-top: 10px; font-weight: bold; }
        .price-group { display: flex; gap: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div id="login-section" style="text-align:center;">
            <h2>ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
            <input type="email" id="email" placeholder="ì•„ì´ë””">
            <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <button onclick="adminLogin()">ì ‘ì†í•˜ê¸°</button>
        </div>

        <div id="admin-section" style="display:none;">
            <div style="text-align:center; margin-bottom:20px;"><b>ê´€ë¦¬ì ëª¨ë“œ (ê°€ì‚¬ ìˆ˜ì • ê¸°ëŠ¥ ì¶”ê°€ë¨)</b></div>
            
            <div class="tab-menu">
                <button class="tab-btn active" onclick="showTab('product')">ì œí’ˆ</button>
                <button class="tab-btn" onclick="showTab('music')">ìŒì•…</button>
                <button class="tab-btn" onclick="showTab('video')">ì˜ìƒ</button>
            </div>

            <div id="tab-product" class="form-group active">
                <h3>ğŸ›ï¸ ì œí’ˆ ë“±ë¡/ìˆ˜ì •</h3>
                <input type="hidden" id="p-key"> <input type="hidden" id="p-old-imgs">
                <label>ì´ë¯¸ì§€ (ìµœëŒ€ 3ì¥)</label>
                <input type="file" id="p-files" accept="image/*" multiple>
                <input type="text" id="p-name" placeholder="ì œí’ˆëª…">
                <div class="price-group">
                    <input type="text" id="p-price-normal" placeholder="ì •ìƒê°€ (ì„ íƒ)" oninput="formatNumber(this)">
                    <input type="text" id="p-price-sale" placeholder="íŒë§¤ê°€ (í•„ìˆ˜)" oninput="formatNumber(this)">
                </div>
                <input type="text" id="p-link" placeholder="êµ¬ë§¤ ë§í¬">
                <textarea id="p-desc" rows="5" placeholder="ì„¤ëª…"></textarea>
                
                <button id="p-btn" onclick="saveProduct()">ì œí’ˆ ì—…ë¡œë“œ</button>
                <button onclick="resetProductForm()" class="reset-btn">ì´ˆê¸°í™”</button>
                
                <div class="item-list"><h4>ë“±ë¡ëœ ì œí’ˆ</h4><div id="product-list"></div></div>
            </div>

            <div id="tab-music" class="form-group">
                <h3>ğŸµ ìŒì•… ë“±ë¡/ìˆ˜ì •</h3>
                <input type="hidden" id="m-key">
                <input type="hidden" id="m-old-url">

                <label>ìŒì•… íŒŒì¼ (ìˆ˜ì • ì‹œ, íŒŒì¼ ë³€ê²½ ì•ˆ í•˜ë ¤ë©´ ë¹„ì›Œë‘ì„¸ìš”)</label>
                <input type="file" id="m-file" accept="audio/*">
                <input type="text" id="m-title" placeholder="ê³¡ ì œëª© (Title)">
                <textarea id="m-lyrics" placeholder="ê°€ì‚¬ ì…ë ¥ (Lyrics) - ì¤„ë°”ê¿ˆ ê°€ëŠ¥" rows="6"></textarea>
                
                <button id="m-btn" onclick="saveMusic()">ìŒì•… ë“±ë¡</button>
                <button onclick="resetMusicForm()" class="reset-btn">ì´ˆê¸°í™”</button>
                
                <div class="item-list"><h4>ë“±ë¡ëœ ìŒì•…</h4><div id="music-list-admin"></div></div>
            </div>

            <div id="tab-video" class="form-group">
                <h3>ğŸ¬ ì˜ìƒ ë“±ë¡</h3>
                <input type="text" id="v-link" placeholder="ìœ íŠœë¸Œ ë§í¬">
                <input type="text" id="v-title" placeholder="ì œëª©">
                <button onclick="uploadVideo()">ì˜ìƒ ì¶”ê°€</button>
                <div class="item-list"><h4>ë“±ë¡ëœ ì˜ìƒ</h4><div id="video-list-admin"></div></div>
            </div>

            <div id="loading-msg" class="loading">ì²˜ë¦¬ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</div>
            <button onclick="auth.signOut(); location.reload();" style="background:#555; margin-top:30px;">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDUoJtrTbXdYaq1MG_QXipkGPC0frKTFHk",
            authDomain: "skin-anointing.firebaseapp.com",
            projectId: "skin-anointing",
            storageBucket: "skin-anointing.firebasestorage.app",
            messagingSenderId: "284785258260",
            appId: "1:284785258260:web:68910599076adad3305c01",
            measurementId: "G-R0K0HQ59YM",
            databaseURL: "https://skin-anointing-default-rtdb.firebaseio.com"
        };

        try {
            firebase.initializeApp(firebaseConfig);
        } catch(e) { console.log("Firebase Init Error"); }
        
        const auth = firebase.auth();
        const db = firebase.database();
        const storage = firebase.storage();

        // [ê³µí†µ] ìˆ«ì ì½¤ë§ˆ í¬ë§·
        function formatNumber(el) { el.value = el.value.replace(/[^0-9]/g, "").replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
        
        // [ê³µí†µ] ë¡œë”© í‘œì‹œ
        function setLoading(b) { document.getElementById('loading-msg').style.display = b?'block':'none'; }

        // [ë¡œê·¸ì¸]
        function adminLogin() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            setLoading(true);
            auth.signInWithEmailAndPassword(e, p).then(() => {
                setLoading(false);
                document.getElementById('login-section').style.display='none';
                document.getElementById('admin-section').style.display='block';
                loadData();
            }).catch(() => { setLoading(false); alert("ë¡œê·¸ì¸ ì‹¤íŒ¨. ì•„ì´ë””/ë¹„ë²ˆì„ í™•ì¸í•˜ì„¸ìš”."); });
        }

        // =======================
        // 1. ì œí’ˆ ê´€ë ¨ í•¨ìˆ˜
        // =======================
        async function saveProduct() {
            const key = document.getElementById('p-key').value;
            const files = document.getElementById('p-files').files;
            const name = document.getElementById('p-name').value;
            const pSale = document.getElementById('p-price-sale').value;
            
            if(!name || !pSale) return alert("ì œí’ˆëª…ê³¼ íŒë§¤ê°€ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");
            setLoading(true);

            try {
                let imgUrls = [];
                // ìƒˆ íŒŒì¼ì´ ìˆìœ¼ë©´ ì—…ë¡œë“œ
                if(files.length > 0) {
                    for(let i=0; i<files.length; i++) {
                        const ref = storage.ref('products/'+Date.now()+'_'+i);
                        await ref.put(files[i]);
                        imgUrls.push(await ref.getDownloadURL());
                    }
                } else {
                    // ì—†ìœ¼ë©´ ê¸°ì¡´ ì´ë¯¸ì§€ ì‚¬ìš©
                    const old = document.getElementById('p-old-imgs').value;
                    if(old) imgUrls = JSON.parse(old);
                }
                
                if(imgUrls.length === 0) throw new Error("ì´ë¯¸ì§€ë¥¼ ìµœì†Œ 1ê°œ ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤.");

                const data = {
                    name: name,
                    priceNormal: document.getElementById('p-price-normal').value,
                    priceSale: pSale,
                    link: document.getElementById('p-link').value,
                    desc: document.getElementById('p-desc').value,
                    images: imgUrls,
                    date: new Date().toISOString()
                };

                if(key) { await db.ref('products/'+key).update(data); alert("ìˆ˜ì • ì™„ë£Œ!"); }
                else { await db.ref('products').push(data); alert("ë“±ë¡ ì™„ë£Œ!"); }
                resetProductForm(); setLoading(false);
            } catch(e) { setLoading(false); alert("ì—ëŸ¬: "+e.message); }
        }

        function resetProductForm() {
            document.getElementById('p-key').value="";
            document.getElementById('p-files').value="";
            document.getElementById('p-name').value="";
            document.getElementById('p-price-normal').value="";
            document.getElementById('p-price-sale').value="";
            document.getElementById('p-link').value="";
            document.getElementById('p-desc').value="";
            document.getElementById('p-old-imgs').value="";
            document.getElementById('p-btn').innerText="ì œí’ˆ ì—…ë¡œë“œ";
        }

        window.editP = function(k, n, pn, ps, l, d, i) {
            document.getElementById('p-key').value=k;
            document.getElementById('p-name').value=n;
            document.getElementById('p-price-normal').value=pn;
            document.getElementById('p-price-sale').value=ps;
            document.getElementById('p-link').value=l;
            document.getElementById('p-desc').value=d;
            document.getElementById('p-old-imgs').value=i;
            document.getElementById('p-btn').innerText="ìˆ˜ì •í•˜ê¸° (ì €ì¥)";
            window.scrollTo(0,0);
        }

        // =======================
        // 2. ìŒì•… ê´€ë ¨ í•¨ìˆ˜ (ê°€ì‚¬ ê¸°ëŠ¥ ê°•í™”)
        // =======================
        async function saveMusic() {
            const key = document.getElementById('m-key').value; // ìˆ˜ì • ëª¨ë“œì¼ ë•Œ í‚¤ê°’
            const file = document.getElementById('m-file').files[0];
            const title = document.getElementById('m-title').value;
            const lyrics = document.getElementById('m-lyrics').value;
            const oldUrl = document.getElementById('m-old-url').value;

            if(!title) return alert("ê³¡ ì œëª©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
            
            // [ì‹ ê·œ ë“±ë¡ì¸ë° íŒŒì¼ì´ ì—†ì„ ë•Œ]
            if(!key && !file) return alert("ìŒì•… íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

            setLoading(true);

            try {
                let downloadUrl = oldUrl; // ê¸°ë³¸ì€ ê¸°ì¡´ URL

                // íŒŒì¼ì´ ìƒˆë¡œ ì„ íƒë˜ì—ˆë‹¤ë©´ ì—…ë¡œë“œ
                if(file) {
                    const storageRef = storage.ref('music/' + Date.now() + "_" + file.name);
                    const snapshot = await storageRef.put(file);
                    downloadUrl = await snapshot.ref.getDownloadURL();
                }

                const musicData = {
                    title: title,
                    fileUrl: downloadUrl,
                    lyrics: lyrics,
                    date: Date.now()
                };

                if(key) {
                    // ìˆ˜ì • ëª¨ë“œ
                    await db.ref('music/' + key).update(musicData);
                    alert("ìŒì•… ì •ë³´(ê°€ì‚¬)ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } else {
                    // ì‹ ê·œ ë“±ë¡
                    await db.ref('music').push(musicData);
                    alert("ìƒˆë¡œìš´ ìŒì•…ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                }

                resetMusicForm();
                setLoading(false);

            } catch(error) {
                setLoading(false);
                alert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + error.message);
            }
        }

        function resetMusicForm() {
            document.getElementById('m-key').value = "";
            document.getElementById('m-old-url').value = "";
            document.getElementById('m-file').value = "";
            document.getElementById('m-title').value = "";
            document.getElementById('m-lyrics').value = "";
            document.getElementById('m-btn').innerText = "ìŒì•… ë“±ë¡";
        }

        // [ì¤‘ìš”] ê°€ì‚¬ì— ì¤„ë°”ê¿ˆì´ ìˆì–´ë„ ê¹¨ì§€ì§€ ì•Šê²Œ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
        window.editM = function(key, title, url, encodedLyrics) {
            document.getElementById('m-key').value = key;
            document.getElementById('m-title').value = title;
            document.getElementById('m-old-url').value = url;
            // ì¸ì½”ë”©ëœ ê°€ì‚¬ë¥¼ ë‹¤ì‹œ ì›ë˜ëŒ€ë¡œ í’€ì–´ì„œ ì…ë ¥ì°½ì— ë„£ìŒ
            document.getElementById('m-lyrics').value = decodeURIComponent(encodedLyrics);
            
            document.getElementById('m-btn').innerText = "ìŒì•… ìˆ˜ì •í•˜ê¸°";
            window.scrollTo(0,0);
        }

        // =======================
        // 3. ì˜ìƒ ê´€ë ¨ í•¨ìˆ˜
        // =======================
        window.uploadVideo = function() {
            const l = document.getElementById('v-link').value;
            const t = document.getElementById('v-title').value;
            let vid = "";
            
            // ìœ íŠœë¸Œ ID ì¶”ì¶œ ë¡œì§
            if(l.includes("youtu.be/")) vid = l.split("youtu.be/")[1].split("?")[0];
            else if(l.includes("v=")) vid = l.split("v=")[1].split("&")[0];
            else if(l.includes("shorts/")) vid = l.split("shorts/")[1].split("?")[0];
            
            if(!vid) return alert("ì˜¬ë°”ë¥¸ ìœ íŠœë¸Œ ë§í¬ê°€ ì•„ë‹™ë‹ˆë‹¤.");
            
            db.ref('videos').push({
                title: t, 
                link: l, 
                thumbnail:`https://img.youtube.com/vi/${vid}/0.jpg`
            });
            alert("ì˜ìƒ ì¶”ê°€ ì™„ë£Œ");
            document.getElementById('v-link').value="";
            document.getElementById('v-title').value="";
        }

        // =======================
        // 4. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° & ì‚­ì œ
        // =======================
        function loadData() {
            // ì œí’ˆ ëª©ë¡
            db.ref('products').on('value', s => {
                const d = document.getElementById('product-list'); d.innerHTML="";
                s.forEach(c => {
                    const v=c.val(); const imgs=JSON.stringify(v.images||[]);
                    d.innerHTML += `
                    <div class="item-row">
                        <div class="item-info">${v.name}</div>
                        <div>
                            <button class="edit-btn" onclick='editP("${c.key}","${v.name}","${v.priceNormal}","${v.priceSale}","${v.link}",\`${v.desc}\`,\`${imgs}\`)'>ìˆ˜ì •</button>
                            <button class="del-btn" onclick="del('products','${c.key}')">ì‚­ì œ</button>
                        </div>
                    </div>`;
                });
            });

            // ìŒì•… ëª©ë¡ (ìˆ˜ì • ë²„íŠ¼ ì¶”ê°€ë¨)
            db.ref('music').on('value', s => {
                const d = document.getElementById('music-list-admin'); d.innerHTML="";
                s.forEach(c => {
                    const v = c.val();
                    // ê°€ì‚¬ì— ì¤„ë°”ê¿ˆì´ë‚˜ íŠ¹ìˆ˜ë¬¸ìê°€ ìˆì–´ë„ ì•ˆì „í•˜ê²Œ ì „ë‹¬í•˜ê¸° ìœ„í•´ ì¸ì½”ë”©
                    const safeLyrics = encodeURIComponent(v.lyrics || "");
                    
                    d.innerHTML += `
                    <div class="item-row">
                        <div class="item-info">${v.title}</div>
                        <div>
                            <button class="edit-btn" onclick="editM('${c.key}', '${v.title}', '${v.fileUrl}', '${safeLyrics}')">ìˆ˜ì •</button>
                            <button class="del-btn" onclick="del('music','${c.key}')">ì‚­ì œ</button>
                        </div>
                    </div>`;
                });
            });

            // ì˜ìƒ ëª©ë¡
            db.ref('videos').on('value', s => {
                const d = document.getElementById('video-list-admin'); d.innerHTML="";
                s.forEach(c => {
                    d.innerHTML += `
                    <div class="item-row">
                        <div class="item-info">${c.val().title}</div>
                        <button class="del-btn" onclick="del('videos','${c.key}')">ì‚­ì œ</button>
                    </div>`;
                });
            });
        }

        window.del = function(collection, key) { 
            if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³µêµ¬ ë¶ˆê°€)")) {
                db.ref(collection+'/'+key).remove(); 
            }
        }

        function showTab(t) {
            document.querySelectorAll('.form-group').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
            document.getElementById('tab-'+t).classList.add('active');
            event.target.classList.add('active');
        }
    </script>
</body>
</html>