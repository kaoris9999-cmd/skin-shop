<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKIN ANOINTING - ADMIN</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        const authCfg = { 
            apiKey: "AIzaSyDUoJtrTbXdYaq1MG_QXipkGPC0frKTFHk", 
            authDomain: "skin-anointing.firebaseapp.com", 
            projectId: "skin-anointing" 
        };
        if (!firebase.apps.length) firebase.initializeApp(authCfg);

        firebase.auth().onAuthStateChanged((user) => {
            const sessionToken = sessionStorage.getItem("skin_admin_token");
            if (!user && sessionToken !== "true") {
                alert("ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ë©”ì¸ì—ì„œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                location.href = "index.html";
            }
        });
    </script>

    <style>
        body { font-family: 'Times New Roman', serif; background-color: #f4f4f4; margin: 0; padding: 20px; }
        .admin-container { max-width: 900px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; margin-bottom: 30px; letter-spacing: 2px; }
        
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab { flex: 1; text-align: center; padding: 15px; cursor: pointer; font-weight: bold; color: #777; transition: 0.3s; background:#f9f9f9; }
        .tab:hover { background: #eee; }
        .tab.active { border-bottom: 3px solid #8b5e3c; color: #8b5e3c; background:#fff; }
        
        .panel { display: none; animation: fadeIn 0.5s; }
        .panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .form-box { background: #fafafa; padding: 25px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 30px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 14px; color: #555; }
        input[type="text"], input[type="file"], textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        
        /* â˜… ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ ìŠ¤íƒ€ì¼ */
        .img-preview-container { 
            display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; 
            padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: 4px; min-height: 80px;
        }
        .img-preview-item { position: relative; width: 70px; height: 70px; border: 1px solid #ccc; border-radius: 4px; overflow: hidden; }
        .img-preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .btn-remove-img {
            position: absolute; top: 0; right: 0; background: rgba(231, 76, 60, 0.9); color: white;
            width: 20px; height: 20px; text-align: center; line-height: 20px; font-size: 12px; cursor: pointer; font-weight: bold;
        }

        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        button.submit-btn { flex: 2; padding: 15px; background: #8b5e3c; color: #fff; border: none; cursor: pointer; font-size: 16px; border-radius: 4px; font-weight: bold; }
        button.submit-btn:hover { background: #6f4b30; }
        button.cancel-btn { flex: 1; padding: 15px; background: #999; color: #fff; border: none; cursor: pointer; font-size: 16px; border-radius: 4px; display: none; }

        .item-list { margin-top: 10px; border-top: 2px solid #333; }
        .item { display: flex; justify-content: space-between; align-items: center; padding: 15px 10px; border-bottom: 1px solid #eee; background: #fff; }
        .item:hover { background: #f9f9f9; }
        .item-info { display: flex; align-items: center; gap: 15px; flex: 1; }
        .item img { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
        .item-text { display: flex; flex-direction: column; }
        .item-title { font-weight: bold; font-size: 16px; color: #333; }
        .item-sub { font-size: 13px; color: #777; margin-top: 4px; }

        .btn-action-group { display: flex; gap: 5px; }
        .btn-edit { background: #3498db; color: #fff; border: none; padding: 8px 15px; cursor: pointer; border-radius: 4px; font-size: 12px; }
        .btn-del { background: #e74c3c; color: #fff; border: none; padding: 8px 15px; cursor: pointer; border-radius: 4px; font-size: 12px; }

        /* í†µê³„ ìŠ¤íƒ€ì¼ */
        .stat-box { margin-bottom: 40px; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-header { font-size: 18px; font-weight: bold; border-left: 4px solid #8b5e3c; padding-left: 10px; margin-bottom: 15px; color: #333; }
        .chart-wrapper { width: 100%; height: 300px; background: #fff; border: 1px solid #eee; padding: 10px; }
        .rank-table { width: 100%; border-collapse: collapse; font-size: 14px; background: #fff; }
        .rank-table th { background: #eee; text-align: left; padding: 12px; border-bottom: 2px solid #ddd; color: #555; }
        .rank-table td { border-bottom: 1px solid #eee; padding: 12px; color: #333; }
        .rank-num { font-weight: bold; color: #8b5e3c; width: 50px; text-align: center; }
    </style>
</head>
<body>

<div class="admin-container">
    <h1>ADMIN DASHBOARD</h1>

    <div class="tabs">
        <div class="tab active" onclick="showPanel('stats')">ğŸ“Š í†µê³„ (Stats)</div>
        <div class="tab" onclick="showPanel('products')">ğŸ›ï¸ ìƒí’ˆ (Product)</div>
        <div class="tab" onclick="showPanel('music')">ğŸµ ìŒì•… (Music)</div>
        <div class="tab" onclick="showPanel('video')">ğŸ¬ ë¹„ë””ì˜¤ (Video)</div>
    </div>

    <div id="stats" class="panel active">
        <div class="stat-box">
            <div class="stat-header">ğŸ“‰ ì£¼ê°„ ë°©ë¬¸ì (Weekly Visitors)</div>
            <div class="chart-wrapper"><canvas id="visitChart"></canvas></div>
        </div>
        <div class="stat-box">
            <div class="stat-header">ğŸ›ï¸ ìƒí’ˆ êµ¬ë§¤ í´ë¦­ ìˆœìœ„</div>
            <table class="rank-table" id="product-rank-table"><tr><td colspan="3">ë¡œë”© ì¤‘...</td></tr></table>
        </div>
        <div class="stat-box">
            <div class="stat-header">ğŸµ ìŒì•… ì¬ìƒ ìˆœìœ„</div>
            <table class="rank-table" id="music-rank-table"><tr><td colspan="3">ë¡œë”© ì¤‘...</td></tr></table>
        </div>
    </div>

    <div id="products" class="panel">
        <div class="form-box">
            <h3 id="p-form-title">ìƒí’ˆ ë“±ë¡ (New Product)</h3>
            <input type="hidden" id="p-key"> 
            
            <div class="form-group"><label>ìƒí’ˆëª…</label><input type="text" id="p-name" placeholder="ì˜ˆ: ìŠ¤í‚¨ ì–´ë…¸ì¸íŒ… í† ë„ˆ"></div>
            
            <div class="form-group"><label>í• ì¸ê°€ (ìˆ«ìë§Œ ì…ë ¥í•˜ë©´ ì½¤ë§ˆ ìë™)</label><input type="text" id="p-price" placeholder="ì˜ˆ: 25,000" onkeyup="inputNumberFormat(this)"></div>
            <div class="form-group"><label>ì •ìƒê°€ (ì„ íƒ)</label><input type="text" id="p-norm" placeholder="ì˜ˆ: 35,000" onkeyup="inputNumberFormat(this)"></div>
            
            <div class="form-group"><label>êµ¬ë§¤ ë§í¬</label><input type="text" id="p-link" placeholder="https://..."></div>
            <div class="form-group"><label>ìƒì„¸ ì„¤ëª…</label><textarea id="p-desc" rows="3"></textarea></div>
            
            <div class="form-group">
                <label>ì´ë¯¸ì§€ (ì—¬ëŸ¬ ë²ˆ ì„ íƒí•´ì„œ ì¶”ê°€ ê°€ëŠ¥)</label>
                <input type="file" id="p-imgs-input" multiple onchange="handleAddImages(this)">
                <div class="img-preview-container" id="p-preview-box">
                    </div>
            </div>
            
            <div class="btn-group">
                <button class="cancel-btn" id="p-cancel" onclick="resetForm('product')">ì·¨ì†Œ</button>
                <button class="submit-btn" id="p-submit" onclick="saveProduct()">ìƒí’ˆ ë“±ë¡</button>
            </div>
        </div>
        <div class="item-list" id="p-list"></div>
    </div>

    <div id="music" class="panel">
        <div class="form-box">
            <h3 id="m-form-title">ìŒì•… ë“±ë¡</h3>
            <input type="hidden" id="m-key">
            <input type="hidden" id="m-old-file">
            <div class="form-group"><label>ê³¡ ì œëª©</label><input type="text" id="m-title"></div>
            <div class="form-group"><label>ê°€ì‚¬</label><textarea id="m-lyrics" rows="5"></textarea></div>
            <div class="form-group"><label>MP3 íŒŒì¼</label><input type="file" id="m-file"></div>
            <div class="btn-group">
                <button class="cancel-btn" id="m-cancel" onclick="resetForm('music')">ì·¨ì†Œ</button>
                <button class="submit-btn" id="m-submit" onclick="saveMusic()">ìŒì•… ë“±ë¡</button>
            </div>
        </div>
        <div class="item-list" id="m-list"></div>
    </div>

    <div id="video" class="panel">
        <div class="form-box">
            <h3 id="v-form-title">ë¹„ë””ì˜¤ ë“±ë¡</h3>
            <input type="hidden" id="v-key">
            <input type="hidden" id="v-old-thumb">
            <div class="form-group"><label>ì˜ìƒ ì œëª©</label><input type="text" id="v-title"></div>
            <div class="form-group"><label>ìœ íŠœë¸Œ ë§í¬</label><input type="text" id="v-link"></div>
            <div class="form-group"><label>ì¸ë„¤ì¼ URL</label><input type="text" id="v-thumb" placeholder="ìë™ ìƒì„±"></div>
            <div class="btn-group">
                <button class="cancel-btn" id="v-cancel" onclick="resetForm('video')">ì·¨ì†Œ</button>
                <button class="submit-btn" id="v-submit" onclick="saveVideo()">ë¹„ë””ì˜¤ ë“±ë¡</button>
            </div>
        </div>
        <div class="item-list" id="v-list"></div>
    </div>
</div>

<script>
    const db = firebase.database();
    const storage = firebase.storage();

    // â˜… [ê¸°ëŠ¥] ê°€ê²© ì½¤ë§ˆ ìë™ ì°ê¸° í•¨ìˆ˜
    function inputNumberFormat(obj) {
        obj.value = comma(uncomma(obj.value));
    }
    function comma(str) {
        str = String(str);
        return str.replace(/(\d)(?=(?:\d{3})+(?!\d))/g, '$1,');
    }
    function uncomma(str) {
        str = String(str);
        return str.replace(/[^\d]+/g, '');
    }

    // â˜… [ê¸°ëŠ¥] ì´ë¯¸ì§€ ëˆ„ì  ê´€ë¦¬ ì‹œìŠ¤í…œ
    let currentProductFiles = []; // í˜„ì¬ ì„ íƒëœ íŒŒì¼ë“¤ (File ê°ì²´ ë˜ëŠ” URL ë¬¸ìì—´)

    function handleAddImages(input) {
        const files = Array.from(input.files);
        if(files.length === 0) return;

        // ë°°ì—´ì— ì¶”ê°€
        currentProductFiles = currentProductFiles.concat(files);
        renderPreview();
        input.value = ""; // ì…ë ¥ì°½ ì´ˆê¸°í™” (ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ê²Œ)
    }

    function renderPreview() {
        const box = document.getElementById('p-preview-box');
        box.innerHTML = "";
        
        currentProductFiles.forEach((file, idx) => {
            const div = document.createElement('div');
            div.className = 'img-preview-item';
            
            // ê¸°ì¡´ ì´ë¯¸ì§€(URL ë¬¸ìì—´)ì¸ì§€ ìƒˆ íŒŒì¼(File ê°ì²´)ì¸ì§€ êµ¬ë¶„
            let src = "";
            if(typeof file === 'string') {
                src = file;
            } else {
                src = URL.createObjectURL(file);
            }

            div.innerHTML = `<img src="${src}"><div class="btn-remove-img" onclick="removeImage(${idx})">X</div>`;
            box.appendChild(div);
        });
    }

    function removeImage(idx) {
        currentProductFiles.splice(idx, 1); // ë°°ì—´ì—ì„œ ì‚­ì œ
        renderPreview(); // í™”ë©´ ê°±ì‹ 
    }

    // íƒ­ ì „í™˜
    function showPanel(id) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        if(id === 'stats') loadStats();
    }

    // ================== 1. ìƒí’ˆ ë¡œì§ (ëŒ€í­ ìˆ˜ì •ë¨) ==================
    function saveProduct() {
        const key = document.getElementById('p-key').value;
        const name = document.getElementById('p-name').value;
        const price = document.getElementById('p-price').value;
        const norm = document.getElementById('p-norm').value;
        const link = document.getElementById('p-link').value;
        const desc = document.getElementById('p-desc').value;

        if(!name || !price) return alert("ìƒí’ˆëª…ê³¼ ê°€ê²©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
        if(currentProductFiles.length === 0) return alert("ì´ë¯¸ì§€ë¥¼ ìµœì†Œ 1ì¥ ë“±ë¡í•´ì£¼ì„¸ìš”.");

        // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬ (Promise.all ì‚¬ìš©)
        const uploadPromises = currentProductFiles.map(item => {
            if(typeof item === 'string') {
                // ì´ë¯¸ URLì¸ ê²½ìš° (ê¸°ì¡´ ì´ë¯¸ì§€)
                return Promise.resolve(item);
            } else {
                // ìƒˆ íŒŒì¼ì¸ ê²½ìš° ì—…ë¡œë“œ
                const ref = storage.ref('products/' + Date.now() + '_' + item.name);
                return ref.put(item).then(s => s.ref.getDownloadURL());
            }
        });

        // ëª¨ë“  ì²˜ë¦¬(ì—…ë¡œë“œ/ìœ ì§€)ê°€ ëë‚˜ë©´ ì €ì¥
        Promise.all(uploadPromises).then(urls => {
            const data = { name, priceSale: price, priceNormal: norm, link, desc, images: urls };
            
            if(key) {
                db.ref('products/' + key).update(data);
                alert("ìˆ˜ì • ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
                db.ref('products').push(data);
                alert("ë“±ë¡ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
            resetForm('product');
        }).catch(err => {
            alert("ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
        });
    }

    function editProduct(key) {
        db.ref('products/' + key).once('value', s => {
            const v = s.val();
            document.getElementById('p-key').value = key;
            document.getElementById('p-name').value = v.name;
            document.getElementById('p-price').value = v.priceSale;
            document.getElementById('p-norm').value = v.priceNormal || "";
            document.getElementById('p-link').value = v.link || "";
            document.getElementById('p-desc').value = v.desc || "";
            
            // ê¸°ì¡´ ì´ë¯¸ì§€ë“¤ì„ ë¯¸ë¦¬ë³´ê¸° ë°°ì—´ì— ë„£ê¸°
            currentProductFiles = v.images || [];
            renderPreview();

            document.getElementById('p-form-title').innerText = "ìƒí’ˆ ìˆ˜ì •";
            const btn = document.getElementById('p-submit');
            btn.innerText = "ìˆ˜ì • ì™„ë£Œ";
            btn.style.background = "#3498db";
            document.getElementById('p-cancel').style.display = "block";
            window.scrollTo(0,0);
        });
    }

    // ================== 2. ìŒì•… ë¡œì§ ==================
    function saveMusic() {
        const key = document.getElementById('m-key').value;
        const title = document.getElementById('m-title').value;
        const lyrics = document.getElementById('m-lyrics').value;
        const file = document.getElementById('m-file').files[0];
        const oldFile = document.getElementById('m-old-file').value;

        if(!title) return alert("ê³¡ ì œëª© í•„ìˆ˜");

        let p;
        if(file) {
            p = storage.ref('music/' + Date.now() + '_' + file.name).put(file).then(s => s.ref.getDownloadURL());
        } else {
            if(key && oldFile) p = Promise.resolve(oldFile);
            else return alert("MP3 íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
        }

        p.then(url => {
            const data = { title, lyrics, fileUrl: url };
            if(key) db.ref('music/' + key).update(data);
            else db.ref('music').push(data);
            alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            resetForm('music');
        });
    }

    function editMusic(key) {
        db.ref('music/' + key).once('value', s => {
            const v = s.val();
            document.getElementById('m-key').value = key;
            document.getElementById('m-title').value = v.title;
            document.getElementById('m-lyrics').value = v.lyrics || "";
            document.getElementById('m-old-file').value = v.fileUrl;
            
            document.getElementById('m-submit').innerText = "ìˆ˜ì • ì™„ë£Œ";
            document.getElementById('m-submit').style.background = "#3498db";
            document.getElementById('m-cancel').style.display = "block";
            window.scrollTo(0,0);
        });
    }

    // ================== 3. ë¹„ë””ì˜¤ ë¡œì§ ==================
    function saveVideo() {
        const key = document.getElementById('v-key').value;
        const title = document.getElementById('v-title').value;
        const link = document.getElementById('v-link').value;
        let thumb = document.getElementById('v-thumb').value;
        const oldThumb = document.getElementById('v-old-thumb').value;

        if(!title || !link) return alert("ì œëª©ê³¼ ë§í¬ í•„ìˆ˜");

        if(!thumb) {
            if(key && oldThumb && !link.includes('youtu')) thumb = oldThumb;
            else {
                try { const vidId = link.split('v=')[1].split('&')[0]; thumb = `https://img.youtube.com/vi/${vidId}/0.jpg`; } 
                catch(e) { thumb = 'logo.jpg'; }
            }
        }
        const data = { title, link, thumbnail: thumb };
        if(key) db.ref('videos/' + key).update(data);
        else db.ref('videos').push(data);
        alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        resetForm('video');
    }

    function editVideo(key) {
        db.ref('videos/' + key).once('value', s => {
            const v = s.val();
            document.getElementById('v-key').value = key;
            document.getElementById('v-title').value = v.title;
            document.getElementById('v-link').value = v.link;
            document.getElementById('v-thumb').value = v.thumbnail;
            document.getElementById('v-old-thumb').value = v.thumbnail;

            document.getElementById('v-submit').innerText = "ìˆ˜ì • ì™„ë£Œ";
            document.getElementById('v-submit').style.background = "#3498db";
            document.getElementById('v-cancel').style.display = "block";
            window.scrollTo(0,0);
        });
    }

    // ================== ê³µí†µ í•¨ìˆ˜ ==================
    function resetForm(type) {
        if(type === 'product') {
            document.getElementById('p-key').value = "";
            document.getElementById('p-name').value = "";
            document.getElementById('p-price').value = "";
            document.getElementById('p-norm').value = "";
            document.getElementById('p-link').value = "";
            document.getElementById('p-desc').value = "";
            document.getElementById('p-imgs-input').value = "";
            currentProductFiles = []; // ì´ë¯¸ì§€ ë°°ì—´ ì´ˆê¸°í™”
            renderPreview(); // ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™”
            
            document.getElementById('p-form-title').innerText = "ìƒí’ˆ ë“±ë¡";
            const btn = document.getElementById('p-submit');
            btn.innerText = "ìƒí’ˆ ë“±ë¡";
            btn.style.background = "#8b5e3c";
            document.getElementById('p-cancel').style.display = "none";
        } 
        // (ìŒì•…, ë¹„ë””ì˜¤ ì´ˆê¸°í™” ë¡œì§ì€ ê¸°ì¡´ê³¼ ë™ì¼)
        else if (type === 'music') {
            document.getElementById('m-key').value = "";
            document.getElementById('m-title').value = "";
            document.getElementById('m-lyrics').value = "";
            document.getElementById('m-file').value = "";
            document.getElementById('m-submit').innerText = "ìŒì•… ë“±ë¡";
            document.getElementById('m-submit').style.background = "#8b5e3c";
            document.getElementById('m-cancel').style.display = "none";
        } else if (type === 'video') {
            document.getElementById('v-key').value = "";
            document.getElementById('v-title').value = "";
            document.getElementById('v-link').value = "";
            document.getElementById('v-thumb').value = "";
            document.getElementById('v-submit').innerText = "ë¹„ë””ì˜¤ ë“±ë¡";
            document.getElementById('v-submit').style.background = "#8b5e3c";
            document.getElementById('v-cancel').style.display = "none";
        }
    }

    function del(path, key) {
        if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) db.ref(path + '/' + key).remove();
    }

    function loadLists() {
        db.ref('products').on('value', s => {
            const d = document.getElementById('p-list'); d.innerHTML="";
            if(s.val()) Object.entries(s.val()).forEach(([k,v]) => {
                const img = v.images ? v.images[0] : 'logo.jpg';
                d.innerHTML += `<div class="item"><div class="item-info"><img src="${img}"><div class="item-text"><div class="item-title">${v.name}</div><div class="item-sub">${v.priceSale}</div></div></div><div class="btn-action-group"><button class="btn-edit" onclick="editProduct('${k}')">ìˆ˜ì •</button><button class="btn-del" onclick="del('products','${k}')">ì‚­ì œ</button></div></div>`;
            });
        });
        db.ref('music').on('value', s => {
            const d = document.getElementById('m-list'); d.innerHTML="";
            if(s.val()) Object.entries(s.val()).forEach(([k,v]) => {
                d.innerHTML += `<div class="item"><div class="item-info"><div class="item-text"><div class="item-title">ğŸµ ${v.title}</div></div></div><div class="btn-action-group"><button class="btn-edit" onclick="editMusic('${k}')">ìˆ˜ì •</button><button class="btn-del" onclick="del('music','${k}')">ì‚­ì œ</button></div></div>`;
            });
        });
        db.ref('videos').on('value', s => {
            const d = document.getElementById('v-list'); d.innerHTML="";
            if(s.val()) Object.entries(s.val()).forEach(([k,v]) => {
                d.innerHTML += `<div class="item"><div class="item-info"><img src="${v.thumbnail}"><div class="item-text"><div class="item-title">ğŸ¬ ${v.title}</div></div></div><div class="btn-action-group"><button class="btn-edit" onclick="editVideo('${k}')">ìˆ˜ì •</button><button class="btn-del" onclick="del('videos','${k}')">ì‚­ì œ</button></div></div>`;
            });
        });
    }

    let visitChartInstance = null;
    function loadStats() {
        db.ref('stats_visits/daily').limitToLast(7).once('value', s => {
            const data = s.val() || {};
            const labels = Object.keys(data).sort();
            const counts = labels.map(date => data[date]);
            const ctx = document.getElementById('visitChart').getContext('2d');
            if(visitChartInstance) visitChartInstance.destroy();
            visitChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: [{ label: 'ë°©ë¬¸ì', data: counts, borderColor: '#8b5e3c', backgroundColor: 'rgba(139, 94, 60, 0.1)', fill: true }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        });
        
        Promise.all([db.ref('stats_product_clicks').once('value'), db.ref('products').once('value')]).then(([c, p]) => {
            const clicks = c.val() || {}, prods = p.val() || {};
            let arr = Object.keys(clicks).map(k => ({ name: prods[k]?prods[k].name:'ì‚­ì œë¨', count: clicks[k] })).sort((a,b)=>b.count-a.count);
            const t = document.getElementById('product-rank-table'); t.innerHTML = `<tr><th>ìˆœìœ„</th><th>ì´ë¦„</th><th>í´ë¦­</th></tr>`;
            arr.forEach((i, idx) => t.innerHTML += `<tr><td class="rank-num">${idx+1}</td><td>${i.name}</td><td>${i.count}</td></tr>`);
        });

        Promise.all([db.ref('stats_music_plays').once('value'), db.ref('music').once('value')]).then(([c, m]) => {
            const plays = c.val() || {}, musics = m.val() || {};
            let arr = Object.keys(plays).map(k => ({ title: musics[k]?musics[k].title:'ì‚­ì œë¨', count: plays[k] })).sort((a,b)=>b.count-a.count);
            const t = document.getElementById('music-rank-table'); t.innerHTML = `<tr><th>ìˆœìœ„</th><th>ê³¡ëª…</th><th>ì¬ìƒ</th></tr>`;
            arr.forEach((i, idx) => t.innerHTML += `<tr><td class="rank-num">${idx+1}</td><td>${i.title}</td><td>${i.count}</td></tr>`);
        });
    }

    loadLists();
    loadStats();
</script>
</body>
</html>
