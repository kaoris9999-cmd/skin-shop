<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKIN ANOINTING - ADMIN</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Times New Roman', serif; background-color: #f4f4f4; margin: 0; padding: 20px; }
        .admin-container { max-width: 900px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; margin-bottom: 30px; }
        
        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab { flex: 1; text-align: center; padding: 15px; cursor: pointer; font-weight: bold; color: #777; transition: 0.3s; }
        .tab:hover { background: #f9f9f9; }
        .tab.active { border-bottom: 3px solid #8b5e3c; color: #8b5e3c; }
        
        .panel { display: none; }
        .panel.active { display: block; }

        /* ì…ë ¥ í¼ */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button.submit-btn { width: 100%; padding: 12px; background: #8b5e3c; color: #fff; border: none; cursor: pointer; font-size: 16px; margin-top: 10px; }
        button.submit-btn:hover { background: #6f4b30; }

        /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .item-list { margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; }
        .item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .item img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; }
        .btn-del { background: #e74c3c; color: #fff; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; }

        /* í†µê³„ ìŠ¤íƒ€ì¼ */
        .stat-box { margin-bottom: 40px; }
        .stat-header { font-size: 18px; font-weight: bold; border-left: 4px solid #8b5e3c; padding-left: 10px; margin-bottom: 15px; color: #333; }
        .chart-wrapper { width: 100%; height: 300px; }
        
        .rank-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .rank-table th { background: #eee; text-align: left; padding: 8px; }
        .rank-table td { border-bottom: 1px solid #eee; padding: 8px; }
        .rank-num { font-weight: bold; color: #8b5e3c; width: 40px; }
    </style>
</head>
<body>

<div class="admin-container">
    <h1>Admin Dashboard</h1>

    <div class="tabs">
        <div class="tab active" onclick="showPanel('stats')">ğŸ“Š í†µê³„ (Stats)</div>
        <div class="tab" onclick="showPanel('products')">ğŸ›ï¸ ìƒí’ˆ (Product)</div>
        <div class="tab" onclick="showPanel('music')">ğŸµ ìŒì•… (Music)</div>
        <div class="tab" onclick="showPanel('video')">ğŸ¬ ë¹„ë””ì˜¤ (Video)</div>
    </div>

    <div id="stats" class="panel active">
        <div class="stat-box">
            <div class="stat-header">ğŸ“‰ ì£¼ê°„ ë°©ë¬¸ì (Weekly Visitors)</div>
            <div class="chart-wrapper">
                <canvas id="visitChart"></canvas>
            </div>
        </div>

        <div class="stat-box">
            <div class="stat-header">ğŸ›ï¸ ìƒí’ˆ 'êµ¬ë§¤í•˜ëŸ¬ ê°€ê¸°' í´ë¦­ ìˆœìœ„</div>
            <table class="rank-table" id="product-rank-table">
                </table>
        </div>

        <div class="stat-box">
            <div class="stat-header">ğŸµ ìŒì•… ì¬ìƒ ìˆœìœ„</div>
            <table class="rank-table" id="music-rank-table">
                </table>
        </div>
    </div>

    <div id="products" class="panel">
        <h3>Add New Product</h3>
        <div class="form-group"><label>ìƒí’ˆëª…</label><input type="text" id="p-name"></div>
        <div class="form-group"><label>í• ì¸ê°€ (ì˜ˆ: 25,000)</label><input type="text" id="p-price"></div>
        <div class="form-group"><label>ì •ìƒê°€ (ì„ íƒ)</label><input type="text" id="p-norm"></div>
        <div class="form-group"><label>êµ¬ë§¤ ë§í¬</label><input type="text" id="p-link"></div>
        <div class="form-group"><label>ìƒì„¸ ì„¤ëª…</label><textarea id="p-desc" rows="3"></textarea></div>
        <div class="form-group"><label>ì´ë¯¸ì§€ (ì—¬ëŸ¬ ì¥ ì„ íƒ ê°€ëŠ¥)</label><input type="file" id="p-imgs" multiple></div>
        <button class="submit-btn" onclick="uploadProduct()">ìƒí’ˆ ë“±ë¡</button>
        <div class="item-list" id="p-list"></div>
    </div>

    <div id="music" class="panel">
        <h3>Add New Music</h3>
        <div class="form-group"><label>ê³¡ ì œëª©</label><input type="text" id="m-title"></div>
        <div class="form-group"><label>ê°€ì‚¬ (ì„ íƒ)</label><textarea id="m-lyrics" rows="5"></textarea></div>
        <div class="form-group"><label>MP3 íŒŒì¼</label><input type="file" id="m-file"></div>
        <button class="submit-btn" onclick="uploadMusic()">ìŒì•… ë“±ë¡</button>
        <div class="item-list" id="m-list"></div>
    </div>

    <div id="video" class="panel">
        <h3>Add New Video Link</h3>
        <div class="form-group"><label>ì˜ìƒ ì œëª©</label><input type="text" id="v-title"></div>
        <div class="form-group"><label>ìœ íŠœë¸Œ ë§í¬</label><input type="text" id="v-link"></div>
        <div class="form-group"><label>ì¸ë„¤ì¼ URL (ìë™ì¶”ì¶œ ì˜ˆì •)</label><input type="text" id="v-thumb" placeholder="ë¹„ì›Œë‘ë©´ ìë™ ìƒì„± ì‹œë„"></div>
        <button class="submit-btn" onclick="uploadVideo()">ë¹„ë””ì˜¤ ë“±ë¡</button>
        <div class="item-list" id="v-list"></div>
    </div>

</div>

<script>
    const cfg = { apiKey: "AIzaSyDUoJtrTbXdYaq1MG_QXipkGPC0frKTFHk", authDomain: "skin-anointing.firebaseapp.com", projectId: "skin-anointing", storageBucket: "skin-anointing.firebasestorage.app", messagingSenderId: "284785258260", appId: "1:284785258260:web:68910599076adad3305c01", measurementId: "G-R0K0HQ59YM", databaseURL: "https://skin-anointing-default-rtdb.firebaseio.com" };
    firebase.initializeApp(cfg);
    const db = firebase.database();
    const storage = firebase.storage();

    function showPanel(id) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        if(id === 'stats') loadStats(); // í†µê³„ íƒ­ ëˆ„ë¥´ë©´ ë°ì´í„° ë¡œë“œ
    }

    // --- [í†µê³„ ë¡œì§] ---
    let visitChartInstance = null;
    function loadStats() {
        // 1. ë°©ë¬¸ì ê·¸ë˜í”„
        db.ref('stats_visits/daily').limitToLast(7).once('value', s => {
            const data = s.val() || {};
            const labels = Object.keys(data).sort();
            const counts = labels.map(date => data[date]);

            const ctx = document.getElementById('visitChart').getContext('2d');
            if(visitChartInstance) visitChartInstance.destroy();
            
            visitChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì¼ë³„ ë°©ë¬¸ì ìˆ˜',
                        data: counts,
                        borderColor: '#8b5e3c',
                        backgroundColor: 'rgba(139, 94, 60, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        });

        // 2. ìƒí’ˆ í´ë¦­ ìˆœìœ„ (ì´ë¦„ ë§¤ì¹­ í•„ìš”)
        Promise.all([
            db.ref('stats_product_clicks').once('value'),
            db.ref('products').once('value')
        ]).then(([clickSnap, prodSnap]) => {
            const clicks = clickSnap.val() || {};
            const products = prodSnap.val() || {};
            
            let rankArr = [];
            Object.keys(clicks).forEach(key => {
                const name = products[key] ? products[key].name : 'ì‚­ì œëœ ìƒí’ˆ';
                rankArr.push({ name: name, count: clicks[key] });
            });
            rankArr.sort((a,b) => b.count - a.count);

            const tbl = document.getElementById('product-rank-table');
            tbl.innerHTML = `<tr><th>ìˆœìœ„</th><th>ìƒí’ˆëª…</th><th>í´ë¦­ìˆ˜</th></tr>`;
            rankArr.forEach((item, i) => {
                tbl.innerHTML += `<tr><td class="rank-num">${i+1}</td><td>${item.name}</td><td>${item.count}íšŒ</td></tr>`;
            });
        });

        // 3. ìŒì•… ì¬ìƒ ìˆœìœ„ (ì œëª© ë§¤ì¹­ í•„ìš”)
        Promise.all([
            db.ref('stats_music_plays').once('value'),
            db.ref('music').once('value')
        ]).then(([playSnap, musicSnap]) => {
            const plays = playSnap.val() || {};
            const musics = musicSnap.val() || {};
            
            let rankArr = [];
            Object.keys(plays).forEach(key => {
                const title = musics[key] ? musics[key].title : 'ì‚­ì œëœ ìŒì•…';
                rankArr.push({ title: title, count: plays[key] });
            });
            rankArr.sort((a,b) => b.count - a.count);

            const tbl = document.getElementById('music-rank-table');
            tbl.innerHTML = `<tr><th>ìˆœìœ„</th><th>ê³¡ ì œëª©</th><th>ì¬ìƒìˆ˜</th></tr>`;
            rankArr.forEach((item, i) => {
                tbl.innerHTML += `<tr><td class="rank-num">${i+1}</td><td>${item.title}</td><td>${item.count}íšŒ</td></tr>`;
            });
        });
    }

    // --- [ê¸°ì¡´ ìƒí’ˆ ë“±ë¡ ë¡œì§] ---
    function uploadProduct() {
        const name = document.getElementById('p-name').value;
        const price = document.getElementById('p-price').value;
        const norm = document.getElementById('p-norm').value;
        const link = document.getElementById('p-link').value;
        const desc = document.getElementById('p-desc').value;
        const files = document.getElementById('p-imgs').files;
        
        if(!name || !price || files.length === 0) return alert("í•„ìˆ˜ ì…ë ¥ í•­ëª©ì„ í™•ì¸í•˜ì„¸ìš”.");

        let uploadPromises = [];
        for(let i=0; i<files.length; i++) {
            const file = files[i];
            const storageRef = storage.ref('products/' + new Date().getTime() + '_' + file.name);
            uploadPromises.push(storageRef.put(file).then(s => s.ref.getDownloadURL()));
        }

        Promise.all(uploadPromises).then(urls => {
            db.ref('products').push({
                name: name, priceSale: price, priceNormal: norm, link: link, desc: desc, images: urls
            });
            alert("ìƒí’ˆ ë“±ë¡ ì™„ë£Œ");
            location.reload();
        });
    }

    // --- [ê¸°ì¡´ ìŒì•… ë“±ë¡ ë¡œì§] ---
    function uploadMusic() {
        const title = document.getElementById('m-title').value;
        const lyrics = document.getElementById('m-lyrics').value;
        const file = document.getElementById('m-file').files[0];
        
        if(!title || !file) return alert("ê³¡ ì œëª©ê³¼ íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.");

        const storageRef = storage.ref('music/' + new Date().getTime() + '_' + file.name);
        storageRef.put(file).then(snapshot => {
            snapshot.ref.getDownloadURL().then(url => {
                db.ref('music').push({ title: title, lyrics: lyrics, fileUrl: url });
                alert("ìŒì•… ë“±ë¡ ì™„ë£Œ");
                location.reload();
            });
        });
    }

    // --- [ê¸°ì¡´ ë¹„ë””ì˜¤ ë“±ë¡ ë¡œì§] ---
    function uploadVideo() {
        const title = document.getElementById('v-title').value;
        const link = document.getElementById('v-link').value;
        let thumb = document.getElementById('v-thumb').value;

        if(!title || !link) return alert("ì œëª©ê³¼ ë§í¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
        if(!thumb) {
            const vidId = link.split('v=')[1];
            if(vidId) thumb = `https://img.youtube.com/vi/${vidId.split('&')[0]}/0.jpg`;
            else thumb = 'logo.jpg';
        }
        db.ref('videos').push({ title: title, link: link, thumbnail: thumb });
        alert("ë¹„ë””ì˜¤ ë“±ë¡ ì™„ë£Œ");
        location.reload();
    }

    // --- [ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° (ì‚­ì œ ê¸°ëŠ¥)] ---
    function loadLists() {
        db.ref('products').on('value', s => {
            const d = document.getElementById('p-list'); d.innerHTML="";
            if(s.val()) Object.entries(s.val()).forEach(([k,v]) => {
                const img = v.images ? v.images[0] : v.imageUrl;
                d.innerHTML += `<div class="item"><img src="${img}"> <span>${v.name}</span> <button class="btn-del" onclick="del('products','${k}')">ì‚­ì œ</button></div>`;
            });
        });
        db.ref('music').on('value', s => {
            const d = document.getElementById('m-list'); d.innerHTML="";
            if(s.val()) Object.entries(s.val()).forEach(([k,v]) => {
                d.innerHTML += `<div class="item"><span>ğŸµ ${v.title}</span> <button class="btn-del" onclick="del('music','${k}')">ì‚­ì œ</button></div>`;
            });
        });
        db.ref('videos').on('value', s => {
            const d = document.getElementById('v-list'); d.innerHTML="";
            if(s.val()) Object.entries(s.val()).forEach(([k,v]) => {
                d.innerHTML += `<div class="item"><span>ğŸ¬ ${v.title}</span> <button class="btn-del" onclick="del('videos','${k}')">ì‚­ì œ</button></div>`;
            });
        });
    }
    
    function del(path, key) {
        if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) db.ref(path + '/' + key).remove();
    }

    // ì´ˆê¸° ì‹¤í–‰
    loadLists();
    loadStats(); // ì²˜ìŒ íƒ­ ë¡œë“œ
</script>
</body>
</html>
