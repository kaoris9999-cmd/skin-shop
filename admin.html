<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKIN ANOINTING - ADMIN</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        const authCfg = { 
            apiKey: "AIzaSyDUoJtrTbXdYaq1MG_QXipkGPC0frKTFHk", 
            authDomain: "skin-anointing.firebaseapp.com", 
            projectId: "skin-anointing" 
        };
        firebase.initializeApp(authCfg);
        
        // ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬ (ì—†ìœ¼ë©´ ë©”ì¸ìœ¼ë¡œ ì¶”ë°©)
        firebase.auth().onAuthStateChanged((user) => {
            const sessionToken = sessionStorage.getItem("skin_admin_token");
            if (!user && sessionToken !== "true") {
                alert("ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                location.href = "index.html";
            }
        });
    </script>

    <style>
        body { font-family: 'Times New Roman', serif; background-color: #f4f4f4; margin: 0; padding: 20px; }
        .admin-container { max-width: 900px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; margin-bottom: 30px; }
        
        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab { flex: 1; text-align: center; padding: 15px; cursor: pointer; font-weight: bold; color: #777; transition: 0.3s; }
        .tab:hover { background: #f9f9f9; }
        .tab.active { border-bottom: 3px solid #8b5e3c; color: #8b5e3c; }
        
        .panel { display: none; }
        .panel.active { display: block; }

        /* ì…ë ¥ í¼ */
        .form-box { background: #fafafa; padding: 20px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 30px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: sans-serif; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        button.submit-btn { flex: 2; padding: 12px; background: #8b5e3c; color: #fff; border: none; cursor: pointer; font-size: 16px; border-radius: 4px; font-weight: bold; }
        button.submit-btn:hover { background: #6f4b30; }
        button.cancel-btn { flex: 1; padding: 12px; background: #999; color: #fff; border: none; cursor: pointer; font-size: 16px; border-radius: 4px; display: none; } /* í‰ì†Œì—” ìˆ¨ê¹€ */

        /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .item-list { margin-top: 10px; border-top: 2px solid #333; }
        .item { display: flex; justify-content: space-between; align-items: center; padding: 15px 10px; border-bottom: 1px solid #eee; background: #fff; }
        .item:hover { background: #f9f9f9; }
        .item-info { display: flex; align-items: center; gap: 15px; flex: 1; }
        .item img { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
        .item-text { display: flex; flex-direction: column; }
        .item-title { font-weight: bold; font-size: 16px; }
        .item-sub { font-size: 13px; color: #777; }

        .btn-action-group { display: flex; gap: 5px; }
        .btn-edit { background: #3498db; color: #fff; border: none; padding: 6px 12px; cursor: pointer; border-radius: 4px; font-size: 12px; }
        .btn-del { background: #e74c3c; color: #fff; border: none; padding: 6px 12px; cursor: pointer; border-radius: 4px; font-size: 12px; }

        /* í†µê³„ ìŠ¤íƒ€ì¼ */
        .stat-box { margin-bottom: 40px; }
        .stat-header { font-size: 18px; font-weight: bold; border-left: 4px solid #8b5e3c; padding-left: 10px; margin-bottom: 15px; color: #333; }
        .chart-wrapper { width: 100%; height: 300px; background: #fff; border: 1px solid #eee; padding: 10px; }
        
        .rank-table { width: 100%; border-collapse: collapse; font-size: 14px; background: #fff; }
        .rank-table th { background: #eee; text-align: left; padding: 10px; border-bottom: 2px solid #ddd; }
        .rank-table td { border-bottom: 1px solid #eee; padding: 10px; }
        .rank-num { font-weight: bold; color: #8b5e3c; width: 50px; text-align: center; }
    </style>
</head>
<body>

<div class="admin-container">
    <h1>ADMIN DASHBOARD</h1>

    <div class="tabs">
        <div class="tab active" onclick="showPanel('stats')">ğŸ“Š í†µê³„ (Stats)</div>
        <div class="tab" onclick="showPanel('products')">ğŸ›ï¸ ìƒí’ˆ (Product)</div>
        <div class="tab" onclick="showPanel('music')">ğŸµ ìŒì•… (Music)</div>
        <div class="tab" onclick="showPanel('video')">ğŸ¬ ë¹„ë””ì˜¤ (Video)</div>
    </div>

    <div id="stats" class="panel active">
        <div class="stat-box">
            <div class="stat-header">ğŸ“‰ ì£¼ê°„ ë°©ë¬¸ì (Weekly Visitors)</div>
            <div class="chart-wrapper">
                <canvas id="visitChart"></canvas>
            </div>
        </div>

        <div class="stat-box">
            <div class="stat-header">ğŸ›ï¸ ìƒí’ˆ êµ¬ë§¤ í´ë¦­ ìˆœìœ„</div>
            <table class="rank-table" id="product-rank-table"></table>
        </div>

        <div class="stat-box">
            <div class="stat-header">ğŸµ ìŒì•… ì¬ìƒ ìˆœìœ„</div>
            <table class="rank-table" id="music-rank-table"></table>
        </div>
    </div>

    <div id="products" class="panel">
        <div class="form-box">
            <h3 id="p-form-title">ìƒí’ˆ ë“±ë¡ (New Product)</h3>
            <input type="hidden" id="p-key"> <input type="hidden" id="p-old-img"> <div class="form-group"><label>ìƒí’ˆëª…</label><input type="text" id="p-name"></div>
            <div class="form-group"><label>í• ì¸ê°€ (ì˜ˆ: 25,000)</label><input type="text" id="p-price"></div>
            <div class="form-group"><label>ì •ìƒê°€ (ì„ íƒ)</label><input type="text" id="p-norm"></div>
            <div class="form-group"><label>êµ¬ë§¤ ë§í¬</label><input type="text" id="p-link"></div>
            <div class="form-group"><label>ìƒì„¸ ì„¤ëª…</label><textarea id="p-desc" rows="3"></textarea></div>
            <div class="form-group">
                <label>ì´ë¯¸ì§€ (ìˆ˜ì • ì‹œ ì„ íƒ ì•ˆ í•˜ë©´ ê¸°ì¡´ ì´ë¯¸ì§€ ìœ ì§€)</label>
                <input type="file" id="p-imgs" multiple>
            </div>
            
            <div class="btn-group">
                <button class="cancel-btn" id="p-cancel" onclick="resetForm('product')">ì·¨ì†Œ</button>
                <button class="submit-btn" id="p-submit" onclick="saveProduct()">ìƒí’ˆ ë“±ë¡</button>
            </div>
        </div>
        <div class="item-list" id="p-list"></div>
    </div>

    <div id="music" class="panel">
        <div class="form-box">
            <h3 id="m-form-title">ìŒì•… ë“±ë¡ (New Music)</h3>
            <input type="hidden" id="m-key">
            <input type="hidden" id="m-old-file">
            
            <div class="form-group"><label>ê³¡ ì œëª©</label><input type="text" id="m-title"></div>
            <div class="form-group"><label>ê°€ì‚¬ (ì„ íƒ)</label><textarea id="m-lyrics" rows="5"></textarea></div>
            <div class="form-group">
                <label>MP3 íŒŒì¼ (ìˆ˜ì • ì‹œ ì„ íƒ ì•ˆ í•˜ë©´ ê¸°ì¡´ íŒŒì¼ ìœ ì§€)</label>
                <input type="file" id="m-file">
            </div>
            
            <div class="btn-group">
                <button class="cancel-btn" id="m-cancel" onclick="resetForm('music')">ì·¨ì†Œ</button>
                <button class="submit-btn" id="m-submit" onclick="saveMusic()">ìŒì•… ë“±ë¡</button>
            </div>
        </div>
        <div class="item-list" id="m-list"></div>
    </div>

    <div id="video" class="panel">
        <div class="form-box">
            <h3 id="v-form-title">ë¹„ë””ì˜¤ ë“±ë¡ (New Video)</h3>
            <input type="hidden" id="v-key">
            <input type="hidden" id="v-old-thumb">
            
            <div class="form-group"><label>ì˜ìƒ ì œëª©</label><input type="text" id="v-title"></div>
            <div class="form-group"><label>ìœ íŠœë¸Œ ë§í¬</label><input type="text" id="v-link"></div>
            <div class="form-group"><label>ì¸ë„¤ì¼ URL (ìë™ìƒì„±)</label><input type="text" id="v-thumb" placeholder="ë¹„ì›Œë‘ë©´ ìë™ ìƒì„±"></div>
            
            <div class="btn-group">
                <button class="cancel-btn" id="v-cancel" onclick="resetForm('video')">ì·¨ì†Œ</button>
                <button class="submit-btn" id="v-submit" onclick="saveVideo()">ë¹„ë””ì˜¤ ë“±ë¡</button>
            </div>
        </div>
        <div class="item-list" id="v-list"></div>
    </div>

</div>

<script>
    const db = firebase.database();
    const storage = firebase.storage();

    // íƒ­ ì „í™˜ í•¨ìˆ˜
    function showPanel(id) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        if(id === 'stats') loadStats();
    }

    // ==========================================
    // 1. ìƒí’ˆ (Product) - ë“±ë¡/ìˆ˜ì •/ì‚­ì œ
    // ==========================================
    function saveProduct() {
        const key = document.getElementById('p-key').value; // í‚¤ê°€ ìˆìœ¼ë©´ ìˆ˜ì •, ì—†ìœ¼ë©´ ë“±ë¡
        const name = document.getElementById('p-name').value;
        const price = document.getElementById('p-price').value;
        const norm = document.getElementById('p-norm').value;
        const link = document.getElementById('p-link').value;
        const desc = document.getElementById('p-desc').value;
        const files = document.getElementById('p-imgs').files;
        const oldImg = document.getElementById('p-old-img').value;

        if(!name || !price) return alert("ìƒí’ˆëª…ê³¼ ê°€ê²©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");

        // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        let uploadPromise;
        if(files.length > 0) {
            // ìƒˆ íŒŒì¼ì´ ìˆìœ¼ë©´ ì—…ë¡œë“œ
            const file = files[0];
            const ref = storage.ref('products/' + new Date().getTime() + '_' + file.name);
            uploadPromise = ref.put(file).then(s => s.ref.getDownloadURL()).then(url => [url]);
        } else {
            // ìƒˆ íŒŒì¼ ì—†ìœ¼ë©´ ê¸°ì¡´ ì´ë¯¸ì§€ ì‚¬ìš©
            if(key && oldImg) uploadPromise = Promise.resolve(JSON.parse(oldImg));
            else return alert("ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
        }

        uploadPromise.then(urls => {
            const data = { name, priceSale: price, priceNormal: norm, link, desc, images: urls };
            
            if(key) { // ìˆ˜ì •
                db.ref('products/' + key).update(data);
                alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else { // ë“±ë¡
                db.ref('products').push(data);
                alert("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
            resetForm('product');
        });
    }

    // ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ í¼ì— ë°ì´í„° ì±„ìš°ê¸°
    function editProduct(key) {
        db.ref('products/' + key).once('value', s => {
            const v = s.val();
            document.getElementById('p-key').value = key;
            document.getElementById('p-name').value = v.name;
            document.getElementById('p-price').value = v.priceSale;
            document.getElementById('p-norm').value = v.priceNormal || "";
            document.getElementById('p-link').value = v.link || "";
            document.getElementById('p-desc').value = v.desc || "";
            document.getElementById('p-old-img').value = JSON.stringify(v.images || []);
            
            // UI ë³€ê²½
            document.getElementById('p-form-title').innerText = "ìƒí’ˆ ìˆ˜ì • (Edit Product)";
            document.getElementById('p-submit').innerText = "ìˆ˜ì • ì™„ë£Œ";
            document.getElementById('p-submit').style.background = "#3498db";
            document.getElementById('p-cancel').style.display = "block";
            window.scrollTo(0,0);
        });
    }

    // ==========================================
    // 2. ìŒì•… (Music) - ë“±ë¡/ìˆ˜ì •/ì‚­ì œ
    // ==========================================
    function saveMusic() {
        const key = document.getElementById('m-key').value;
        const title = document.getElementById('m-title').value;
        const lyrics = document.getElementById('m-lyrics').value;
        const file = document.getElementById('m-file').files[0];
        const oldFile = document.getElementById('m-old-file').value;

        if(!title) return alert("ê³¡ ì œëª©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");

        let uploadPromise;
        if(file) {
            const ref = storage.ref('music/' + new Date().getTime() + '_' + file.name);
            uploadPromise = ref.put(file).then(s => s.ref.getDownloadURL());
        } else {
            if(key && oldFile) uploadPromise = Promise.resolve(oldFile);
            else return alert("ìŒì•… íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        }

        uploadPromise.then(url => {
            const data = { title, lyrics, fileUrl: url };
            if(key) {
                db.ref('music/' + key).update(data);
                alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
                db.ref('music').push(data);
                alert("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
            resetForm('music');
        });
    }

    function editMusic(key) {
        db.ref('music/' + key).once('value', s => {
            const v = s.val();
            document.getElementById('m-key').value = key;
            document.getElementById('m-title').value = v.title;
            document.getElementById('m-lyrics').value = v.lyrics || "";
            document.getElementById('m-old-file').value = v.fileUrl;

            document.getElementById('m-form-title').innerText = "ìŒì•… ìˆ˜ì • (Edit Music)";
            document.getElementById('m-submit').innerText = "ìˆ˜ì • ì™„ë£Œ";
            document.getElementById('m-submit').style.background = "#3498db";
            document.getElementById('m-cancel').style.display = "block";
            window.scrollTo(0,0);
        });
    }

    // ==========================================
    // 3. ë¹„ë””ì˜¤ (Video) - ë“±ë¡/ìˆ˜ì •/ì‚­ì œ
    // ==========================================
    function saveVideo() {
        const key = document.getElementById('v-key').value;
        const title = document.getElementById('v-title').value;
        const link = document.getElementById('v-link').value;
        let thumb = document.getElementById('v-thumb').value;
        const oldThumb = document.getElementById('v-old-thumb').value;

        if(!title || !link) return alert("ì œëª©ê³¼ ë§í¬ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");

        if(!thumb) {
            if(key && oldThumb && !link.includes('youtu')) thumb = oldThumb; // ê¸°ì¡´ ìœ ì§€
            else {
                // ìœ íŠœë¸Œ ì¸ë„¤ì¼ ìë™ ì¶”ì¶œ
                try {
                    const vidId = link.split('v=')[1].split('&')[0];
                    thumb = `https://img.youtube.com/vi/${vidId}/0.jpg`;
                } catch(e) { thumb = 'logo.jpg'; }
            }
        }

        const data = { title, link, thumbnail: thumb };
        if(key) {
            db.ref('videos/' + key).update(data);
            alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
            db.ref('videos').push(data);
            alert("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
        resetForm('video');
    }

    function editVideo(key) {
        db.ref('videos/' + key).once('value', s => {
            const v = s.val();
            document.getElementById('v-key').value = key;
            document.getElementById('v-title').value = v.title;
            document.getElementById('v-link').value = v.link;
            document.getElementById('v-thumb').value = v.thumbnail;
            document.getElementById('v-old-thumb').value = v.thumbnail;

            document.getElementById('v-form-title').innerText = "ë¹„ë””ì˜¤ ìˆ˜ì • (Edit Video)";
            document.getElementById('v-submit').innerText = "ìˆ˜ì • ì™„ë£Œ";
            document.getElementById('v-submit').style.background = "#3498db";
            document.getElementById('v-cancel').style.display = "block";
            window.scrollTo(0,0);
        });
    }

    // ==========================================
    // 4. ê³µí†µ í•¨ìˆ˜ (ì´ˆê¸°í™”, ì‚­ì œ, ë¦¬ìŠ¤íŠ¸ ë¡œë“œ)
    // ==========================================
    function resetForm(type) {
        if(type === 'product') {
            document.getElementById('p-key').value = "";
            document.getElementById('p-name').value = "";
            document.getElementById('p-price').value = "";
            document.getElementById('p-norm').value = "";
            document.getElementById('p-link').value = "";
            document.getElementById('p-desc').value = "";
            document.getElementById('p-imgs').value = "";
            document.getElementById('p-form-title').innerText = "ìƒí’ˆ ë“±ë¡ (New Product)";
            document.getElementById('p-submit').innerText = "ìƒí’ˆ ë“±ë¡";
            document.getElementById('p-submit').style.background = "#8b5e3c";
            document.getElementById('p-cancel').style.display = "none";
        } else if (type === 'music') {
            document.getElementById('m-key').value = "";
            document.getElementById('m-title').value = "";
            document.getElementById('m-lyrics').value = "";
            document.getElementById('m-file').value = "";
            document.getElementById('m-form-title').innerText = "ìŒì•… ë“±ë¡ (New Music)";
            document.getElementById('m-submit').innerText = "ìŒì•… ë“±ë¡";
            document.getElementById('m-submit').style.background = "#8b5e3c";
            document.getElementById('m-cancel').style.display = "none";
        } else if (type === 'video') {
            document.getElementById('v-key').value = "";
            document.getElementById('v-title').value = "";
            document.getElementById('v-link').value = "";
            document.getElementById('v-thumb').value = "";
            document.getElementById('v-form-title').innerText = "ë¹„ë””ì˜¤ ë“±ë¡ (New Video)";
            document.getElementById('v-submit').innerText = "ë¹„ë””ì˜¤ ë“±ë¡";
            document.getElementById('v-submit').style.background = "#8b5e3c";
            document.getElementById('v-cancel').style.display = "none";
        }
    }

    function del(path, key) {
        if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³µêµ¬ ë¶ˆê°€)")) {
            db.ref(path + '/' + key).remove();
        }
    }

    // ë¦¬ìŠ¤íŠ¸ ì‹¤ì‹œê°„ ë¶ˆëŸ¬ì˜¤ê¸° (ìˆ˜ì • ë²„íŠ¼ ì¶”ê°€ë¨)
    function loadLists() {
        db.ref('products').on('value', s => {
            const d = document.getElementById('p-list'); d.innerHTML="";
            if(s.val()) Object.entries(s.val()).forEach(([k,v]) => {
                const img = v.images ? v.images[0] : v.imageUrl;
                d.innerHTML += `
                    <div class="item">
                        <div class="item-info">
                            <img src="${img}">
                            <div class="item-text">
                                <div class="item-title">${v.name}</div>
                                <div class="item-sub">${v.priceSale}</div>
                            </div>
                        </div>
                        <div class="btn-action-group">
                            <button class="btn-edit" onclick="editProduct('${k}')">ìˆ˜ì •</button>
                            <button class="btn-del" onclick="del('products','${k}')">ì‚­ì œ</button>
                        </div>
                    </div>`;
            });
        });

        db.ref('music').on('value', s => {
            const d = document.getElementById('m-list'); d.innerHTML="";
            if(s.val()) Object.entries(s.val()).forEach(([k,v]) => {
                d.innerHTML += `
                    <div class="item">
                        <div class="item-info">
                            <div class="item-text">
                                <div class="item-title">ğŸµ ${v.title}</div>
                            </div>
                        </div>
                        <div class="btn-action-group">
                            <button class="btn-edit" onclick="editMusic('${k}')">ìˆ˜ì •</button>
                            <button class="btn-del" onclick="del('music','${k}')">ì‚­ì œ</button>
                        </div>
                    </div>`;
            });
        });

        db.ref('videos').on('value', s => {
            const d = document.getElementById('v-list'); d.innerHTML="";
            if(s.val()) Object.entries(s.val()).forEach(([k,v]) => {
                d.innerHTML += `
                    <div class="item">
                        <div class="item-info">
                            <img src="${v.thumbnail}">
                            <div class="item-text">
                                <div class="item-title">ğŸ¬ ${v.title}</div>
                            </div>
                        </div>
                        <div class="btn-action-group">
                            <button class="btn-edit" onclick="editVideo('${k}')">ìˆ˜ì •</button>
                            <button class="btn-del" onclick="del('videos','${k}')">ì‚­ì œ</button>
                        </div>
                    </div>`;
            });
        });
    }

    // ==========================================
    // 5. í†µê³„ ë¡œì§ (ê·¸ë˜í”„, ìˆœìœ„)
    // ==========================================
    let visitChartInstance = null;
    function loadStats() {
        db.ref('stats_visits/daily').limitToLast(7).once('value', s => {
            const data = s.val() || {};
            const labels = Object.keys(data).sort();
            const counts = labels.map(date => data[date]);

            const ctx = document.getElementById('visitChart').getContext('2d');
            if(visitChartInstance) visitChartInstance.destroy();
            
            visitChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì¼ë³„ ë°©ë¬¸ì ìˆ˜',
                        data: counts,
                        borderColor: '#8b5e3c',
                        backgroundColor: 'rgba(139, 94, 60, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        });

        Promise.all([db.ref('stats_product_clicks').once('value'), db.ref('products').once('value')])
        .then(([clickSnap, prodSnap]) => {
            const clicks = clickSnap.val() || {};
            const products = prodSnap.val() || {};
            let rankArr = [];
            Object.keys(clicks).forEach(key => {
                const name = products[key] ? products[key].name : 'ì‚­ì œëœ ìƒí’ˆ';
                rankArr.push({ name: name, count: clicks[key] });
            });
            rankArr.sort((a,b) => b.count - a.count);
            const tbl = document.getElementById('product-rank-table');
            tbl.innerHTML = `<tr><th>ìˆœìœ„</th><th>ìƒí’ˆëª…</th><th>í´ë¦­ìˆ˜</th></tr>`;
            rankArr.forEach((item, i) => {
                tbl.innerHTML += `<tr><td class="rank-num">${i+1}</td><td>${item.name}</td><td>${item.count}íšŒ</td></tr>`;
            });
        });

        Promise.all([db.ref('stats_music_plays').once('value'), db.ref('music').once('value')])
        .then(([playSnap, musicSnap]) => {
            const plays = playSnap.val() || {};
            const musics = musicSnap.val() || {};
            let rankArr = [];
            Object.keys(plays).forEach(key => {
                const title = musics[key] ? musics[key].title : 'ì‚­ì œëœ ìŒì•…';
                rankArr.push({ title: title, count: plays[key] });
            });
            rankArr.sort((a,b) => b.count - a.count);
            const tbl = document.getElementById('music-rank-table');
            tbl.innerHTML = `<tr><th>ìˆœìœ„</th><th>ê³¡ ì œëª©</th><th>ì¬ìƒìˆ˜</th></tr>`;
            rankArr.forEach((item, i) => {
                tbl.innerHTML += `<tr><td class="rank-num">${i+1}</td><td>${item.title}</td><td>${item.count}íšŒ</td></tr>`;
            });
        });
    }

    loadLists();
    loadStats();
</script>
</body>
</html>
